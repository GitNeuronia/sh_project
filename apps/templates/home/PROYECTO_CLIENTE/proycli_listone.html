{% extends "layouts/base.html" %}
{% block title %} Proyectos de Cliente {% endblock %} 

{% block stylesheets %}
    {% load i18n %}
    {% load l10n %}
    {% load humanize %}
    {% load custom_filters %}
    <!-- Estilos existentes -->
    <link rel="stylesheet" href="/static/assets/css/plugins/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    {% comment %} <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/dataTables.bootstrap4.min.css"/> {% endcomment %}
    
    <style>
        /* Estilos existentes */
        .progress {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            overflow: hidden;
        }
        .progress-bar {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            color: white;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
            transition: width 0.6s ease;
            padding-left: 10px;
            font-weight: bold;
        }
        .progress-bar[style^="width: 100%"] {
            border-top-right-radius: 0.25rem;
            border-bottom-right-radius: 0.25rem;
        }
        .progress-bar[style^="width: 0%"] {
            color: black;
            text-shadow: none;
        }
        .handle-group, .handle {
            display: none !important;
        }
        .bar-wrapper {
            cursor: default !important;
        }
        .bar-wrapper:hover {
            cursor: default !important;
        }
        .fa-exclamation-triangle {
            color: #ffc107;
            font-size: 1.2em;
            vertical-align: middle;
            cursor: pointer;
        }
        .fa-exclamation-triangle:hover {
            color: #e0a800;
        }
        #edpModal .modal-content {
            border-radius: 0.5rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        
        #edpModal .modal-header {
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }
        
        #edpModal .form-control {
            border-radius: 0.25rem;
        }
        
        #edpModal .btn {
            border-radius: 0.25rem;
        }
        
        #edpTable {
            font-size: 0.9rem;
        }
        
        #edpTable th,
        #edpTable td {
            padding: 0.5rem;
            vertical-align: middle;
        }
        
        #edpTable .form-control {
            padding: 0.25rem 0.5rem;
            height: auto;
        }
        
         /* Nuevos estilos para tablas responsivas */
        {% comment %}.table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        @media screen and (max-width: 992px) {
            .table-responsive table {
                min-width: 800px;
            }
        }
        
        .table th, .table td {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        
        .table .actions-column {
            min-width: 200px;
            width: 200px;
        }
        
        .table .progress-column {
            min-width: 150px;
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button {
            padding: 0.25em 0.5em;
        }
        
        .dataTables_wrapper .dataTables_length select {
            width: 60px;
        } {% endcomment %}
    </style>
{% endblock stylesheets %}

{% block content %}	

    <!-- [ Main Content ] start -->
    <section class="pcoded-main-container">
        <div class="pcoded-content">
            <!-- [ breadcrumb ] start -->
            <div class="page-header">
                <div class="page-block">
                    <div class="row align-items-center">
                        <div class="col-md-12">
                            <div class="page-header-title">
                                <h5 class="m-b-10">Proyectos de Cliente - ODT</h5>
                            </div>
                            <ul class="breadcrumb">
                                <li class="breadcrumb-item"><a href="/"><i class="feather icon-home"></i></a></li>
                                <li class="breadcrumb-item"><a href="/">Gestión de Proyectos</a></li>
                                <li class="breadcrumb-item"><a href="{% url 'proycli_listall' %}">Proyectos de Cliente - ODT</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- [ breadcrumb ] end -->
            <!-- [ Main Content ] start -->
            <div class="row">
                <!-- Detalles del proyecto -->
                <div class="col-md-12">
                    <div class="card shadow-lg rounded-lg overflow-hidden">
                        <div class="card-header bg-primary">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h4 class="mb-0 text-white"><i class="fas fa-project-diagram mr-2"></i>{{ proyecto.PC_CNOMBRE }}</h4>
                                </div>
                                <div class="col-md-6 text-right">
                                    <a href="{% url 'proycli_update' proyecto.id 1 %}" class="btn btn-light btn-sm rounded-pill shadow-sm hover-lift mr-2">
                                        <i class="fas fa-edit mr-2"></i>Editar Proyecto
                                    </a>
                                    <button type="button" class="btn btn-light btn-sm rounded-pill shadow-sm hover-lift" data-toggle="modal" data-target="#documentosModal" data-url="{% url 'proycli_documentos_modal' proyecto.id %}">
                                        <i class="fas fa-file-alt mr-2 text-primary"></i>Ver Documentación
                                    </button>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <h5 class="mb-3 text-primary"><i class="fas fa-info-circle mr-2"></i>Información General</h5>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><i class="fas fa-file-signature mr-2 text-muted"></i><strong>Proyecto:</strong> {{ proyecto.PC_CONTRATO_CLIENTE }}</li>
                                        <li class="mb-2"><i class="fas fa-hashtag mr-2 text-muted"></i><strong>Código ODT:</strong> {{ proyecto.PC_CCODIGO }} </li>
                                        <!-- Botón para mostrar la información del cliente -->
                                        <li class="mb-2">
                                            <i class="fas fa-user mr-2 text-muted"></i><strong>Cliente:</strong>
                                            <button type="button" class="btn btn-link p-0" data-toggle="modal" data-target="#clienteModal" data-url="{% url 'cliente_modal' proyecto.PC_CLIENTE.id %}">
                                                {{ proyecto.PC_CLIENTE.CL_CNOMBRE }}
                                            </button>
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-folder mr-2 text-muted"></i><strong>Categoría:</strong> 
                                            <span class="badge badge-pill badge-info">{{ proyecto.PC_CCATEGORIA.CA_CNOMBRE|default:"No especificada" }}</span>
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-tag mr-2 text-muted"></i><strong>Tipo:</strong> 
                                            <span class="badge badge-pill badge-success">{{ proyecto.PC_CTIPO.TP_CNOMBRE|default:"No especificado" }}</span>
                                        </li>
                                    </ul>
                                </div>
                                <div class="col-md-4">
                                    <h5 class="mb-3 text-primary"><i class="fas fa-calendar-alt mr-2"></i>Fechas</h5>
                                    <ul class="list-unstyled">
                                        <li class="mb-2"><i class="fas fa-play mr-2 text-muted"></i><strong>Inicio:</strong> {{ proyecto.PC_FFECHA_INICIO|date:"d/m/Y" }}</li>
                                        <li class="mb-2"><i class="fas fa-flag-checkered mr-2 text-muted"></i><strong>Fin estimado:</strong> {{ proyecto.PC_FFECHA_FIN_ESTIMADA|date:"d/m/Y" }}</li>
                                        <li class="mb-2">
                                            <i class="fas fa-stop mr-2 text-muted"></i><strong>Fin real:</strong>
                                            {% if proyecto.PC_FFECHA_FIN_REAL %}
                                                {% if proyecto.PC_FFECHA_FIN_REAL <= proyecto.PC_FFECHA_FIN_ESTIMADA %}
                                                    <span class="badge badge-success">{{ proyecto.PC_FFECHA_FIN_REAL|date:"d/m/Y" }}</span>
                                                {% else %}
                                                    <span class="badge badge-danger">{{ proyecto.PC_FFECHA_FIN_REAL|date:"d/m/Y" }}</span>
                                                {% endif %}
                                            {% else %}
                                                {% now "Y-m-d" as current_date %}
                                                {% if proyecto.PC_FFECHA_FIN_ESTIMADA|date:"Y-m-d" >= current_date %}
                                                    <span class="badge badge-success">No finalizado</span>
                                                {% else %}
                                                    <span class="badge badge-danger">No finalizado</span>
                                                {% endif %}
                                            {% endif %}
                                        </li>
                                        <li class="mb-2">
                                            <i class="fas fa-tasks mr-2 text-muted"></i><strong>Estado:</strong> 
                                            <span class="badge badge-pill badge-warning">{{ proyecto.PC_CESTADO }}</span>
                                        </li>
                                    </ul>
                                </div>
                                <div class="col-md-4">
                                    <h5 class="mb-3 text-primary"><i class="fas fa-chart-line mr-2"></i>Finanzas y Progreso</h5>
                                    <ul class="list-unstyled">
                                        <li class="mb-2">
                                            <i class="fas fa-money-bill-wave mr-2 text-muted"></i><strong>Presupuesto:</strong>
                                            
                                            {{ proyecto.PC_MONEDA|default_if_none:" " }} {{ proyecto.PC_NPRESUPUESTO|floatformat:0|intcomma }}
                                            
                                        </li>
                                        {% comment %} <li class="mb-2"><i class="fas fa-clock mr-2 text-muted"></i><strong>Valor/hora:</strong> ${{ proyecto.PC_NVALOR_HORA|floatformat:0|intcomma }}</li> {% endcomment %}
                                        <li class="mb-2"><i class="fas fa-percentage mr-2 text-muted"></i><strong>Margen:</strong> {{ proyecto.PC_NMARGEN|floatformat:0 }}%</li>
                                        <li class="mb-2"><i class="fas fa-hourglass-half mr-2 text-muted"></i><strong>Horas est/real:</strong> {{ proyecto.PC_NHORAS_ESTIMADAS }} / {{ horas_utilizadas |floatformat:0  }}</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="row mt-4">
                                <div class="col-md-12">
                                    <h5 class="mb-3 text-primary"><i class="fas fa-calculator mr-2"></i> Resumen de Costos</h5>
                                    <div class="row">
                                        <div class="col-md-6 col-xl-4">
                                            <div class="card bg-c-red order-card" data-toggle="modal" data-target="#detalleCostoModal">
                                                <div class="card-body" id="proyectos-activos-card">
                                                    <h6 class="text-white">Costo de ODT</h6>
                                                    <h2 class="text-right text-white"><i class="fas fa-money-bill float-left"></i><span>{{ costo_real|floatformat:0|intcomma }}</span></h2>
                                                    <p class="text-right text-white"><span>Horas utilizadas: {{ horas_utilizadas|floatformat:0|intcomma }}</span></p>
                                                    <p class="m-b-0"><span class="float-right"></span></p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6 col-xl-4">
                                            <div class="card bg-c-green order-card" >
                                                <div class="card-body" id="proyectos-activos-card">
                                                    <h6 class="text-white">Monto EDP Emitido</h6>
                                                    <h2 class="text-right text-white"><i class="fas fa-money-bill float-left"></i><span>{{ monto_pendiente.0 }} {{ monto_pendiente.1|floatformat:0|intcomma }}</span></h2>
                                                    <p class="text-right text-white"><span>Cantidad de documentos: {{ cantidad_doc_edp }}</span></p>
                                                    <p class="m-b-0"><span class="float-right"></span></p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 col-xl-4">
                                            <div class="card bg-c-blue order-card">
                                                <div class="card-body" id="proyectos-activos-card">
                                                    <h6 class="text-white">Monto EDP Pagado</h6>
                                                    <h2 class="text-right text-white"><i class="fas fa-money-bill float-left"></i><span>{{ monto_pagado.0 }} {{ monto_pagado.1|floatformat:0|intcomma }}</span></h2>
                                                    <p class="text-right text-white"><span>Saldo pendiente: {{ saldo_pendiente|floatformat:0|intcomma }}</span></p>
                                                    <p class="m-b-0"><span class="float-right"></span></p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                    </div>

                                    <!-- Modal -->
                                    <div class="modal fade" id="detalleCostoModal" tabindex="-1" role="dialog" aria-labelledby="detalleCostoModalLabel" aria-hidden="true">
                                        <div class="modal-dialog modal-lg" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header bg-primary text-white">
                                                    <h5 class="modal-title text-white" id="detalleCostoModalLabel">Detalle de Costo Real</h5>
                                                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                                                        <span aria-hidden="true">&times;</span>
                                                    </button>
                                                </div>
                                                <div class="modal-body">
                                                    <table class="table">
                                                        <thead>
                                                            <tr>
                                                                <th>Usuario</th>
                                                                <th>Costo Total</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for detalle in detalle_costo_real %}
                                                                <tr>
                                                                    <td>{{ detalle.0 }}</td>
                                                                    <td>{{ detalle.1 }} {{ detalle.2|floatformat:0|intcomma }}</td>
                                                                </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                                                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#detalleAperturaModal" data-dismiss="modal">Ver Detalle Apertura Costo Real</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Modal Detalle Apertura Costo Real -->
                                    <div class="modal fade" id="detalleAperturaModal" tabindex="-1" role="dialog" aria-labelledby="detalleAperturaModalLabel" aria-hidden="true">
                                        <div class="modal-dialog modal-lg" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header bg-primary text-white">
                                                    <h5 class="modal-title text-white" id="detalleAperturaModalLabel">Detalle Apertura Costo Real</h5>
                                                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                                                        <span aria-hidden="true">&times;</span>
                                                    </button>
                                                </div>
                                                <div class="modal-body">
                                                    <!-- Aquí se cargará la información de detalle_apertura_costo_real -->
                                                    <table class="table" id ='tabla_detalle_apertura'>
                                                        <thead>
                                                            <tr>
                                                                <th>Usuario</th>
                                                                <th>Fecha</th>
                                                                <th>Horas</th>
                                                                <th>Costo por hora</th>
                                                                <th>Total</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for detalle in detalle_apertura_costo_real %}
                                                                <tr>
                                                                    <td>{{ detalle.0 }}</td>
                                                                    <td>{{ detalle.1|date:"d/m/Y" }}</td>
                                                                    <td>{{ detalle.2|floatformat:0|intcomma }}</td>
                                                                    <td>{{ detalle.5|default_if_none:" " }} {{ detalle.3|floatformat:0|intcomma }}</td>
                                                                    <td>{{ detalle.5|default_if_none:" " }} {{ detalle.4|floatformat:0|intcomma }}</td>
                                                                </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- <div class="progress-group">
                                        <div class="mb-2">
                                            <strong>Costo Real:</strong>
                                            
                                            {{ proyecto.PC_MONEDA|default_if_none:" " }} {{ proyecto.PC_NCOSTO_REAL|floatformat:0|intcomma }}
                                            
                                            {% if proyecto.PC_NCOSTO_REAL > proyecto.PC_NCOSTO_ESTIMADO %}
                                                <span class="text-danger ml-2">
                                                    <i class="fas fa-exclamation-triangle"></i>
                                                    Exceso: 
                                                    
                                                    {{ proyecto.PC_MONEDA|default_if_none:" " }} {{ proyecto.PC_NCOSTO_REAL|subtract:proyecto.PC_NCOSTO_ESTIMADO|floatformat:0|intcomma }}
                                                    
                                                </span>
                                            {% endif %}
                                        </div>
                                        <div class="progress mb-3" style="height: 20px;">
                                            <div class="progress-bar bg-danger" role="progressbar" style="width: {% widthratio proyecto.PC_NCOSTO_REAL max_costo 100 %}%" aria-valuenow="{{ proyecto.PC_NCOSTO_REAL }}" aria-valuemin="0" aria-valuemax="{{ max_costo }}">
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Costo Estimado:</strong>
                                            
                                            {{ proyecto.PC_MONEDA|default_if_none:" " }} {{ proyecto.PC_NCOSTO_ESTIMADO|floatformat:0|intcomma }}
                                            
                                        </div>
                                        <div class="progress mb-3" style="height: 20px;">
                                            <div class="progress-bar bg-info" role="progressbar" style="width: {% widthratio proyecto.PC_NCOSTO_ESTIMADO max_costo 100 %}%" aria-valuenow="{{ proyecto.PC_NCOSTO_ESTIMADO }}" aria-valuemin="0" aria-valuemax="{{ max_costo }}">
                                            </div>
                                        </div>
                                    </div> -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {% comment %} <!-- Gráfico de avance -->
                <div class="col-md-3"></div>
                <div class="col-md-6 mt-3">
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h6>Avance del Proyecto</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="avanceChart" height="150"></canvas>
                        </div>
                    </div>
                </div>                
                <div class="col-md-3"></div> {% endcomment %}                
                
                <!-- Tabs de tareas -->
                <div class="col-md-12 mt-4">
                    <div class="card shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <ul class="nav nav-tabs card-header-tabs" id="tareasTabs" role="tablist">
                                <li class="nav-item">
                                    <a class="nav-link active" id="financieras-tab" data-toggle="tab" href="#financieras" role="tab">Tareas Financieras</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="generales-tab" data-toggle="tab" href="#generales" role="tab">Tareas Generales</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="ingenieria-tab" data-toggle="tab" href="#ingenieria" role="tab">Tareas de Ingeniería</a>
                                </li>
                            </ul>
                            <div class="dropdown">
                                <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Agregar
                                </button>
                                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                    {% comment %} <a class="dropdown-item" href="{% url 'tarea_financiera_addone' 1 proyecto.id %}">Tarea Financiera</a> {% endcomment %}
                                    <a class="dropdown-item" href="#" data-toggle="modal" data-target="#edpModal">Tarea Financiera</a>
                                    <div class="dropdown-divider"></div>
                                    <a class="dropdown-item" href="{% url 'tarea_general_addone' 1 proyecto.id %}">Tarea General</a>
                                    <a class="dropdown-item" href="{% url 'tarea_ingenieria_addone' 1 proyecto.id %}">Tarea de Ingeniería</a>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="tab-content" id="tareasTabsContent">
                                <div class="tab-pane fade show active" id="financieras" role="tabpanel">
                                    <h5>Tareas Financieras</h5>
                                    <div class="dt-responsive table-responsive">
                                        <table id="tabla-financieras" class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Acción</th>
                                                    <th>Nombre</th>
                                                    <th>Descripción</th>
                                                    <th>Fecha de Inicio</th>
                                                    <th>Monto</th>
                                                    <th>Monto Pagado</th>
                                                    <th>Porcentaje Avance</th>
                                                    <th>Cobro Emitido</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for tarea in tareas_financiera %}
                                                <tr>
                                                    <td>
                                                        {% comment %} <a href="{% url 'tarea_financiera_listone' tarea.id 1 %}" class="btn btn-sm btn-info mr-1" title="Ver detalles"><i class="fas fa-eye"></i></a>
                                                        <a href="{% url 'tarea_financiera_update' tarea.id 1 %}" class="btn btn-sm btn-primary mr-1" title="Editar"><i class="fas fa-edit"></i></a> {% endcomment %}
                                                        {% comment %} <a href="{% url 'tarea_financiera_update_asignaciones' tarea.id 1 %}" class="btn btn-sm btn-info mr-1" title="Asignar recursos">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-people" viewBox="0 0 16 16">
                                                                <path d="M15 14s1 0 1-1-1-4-5-4-5 3-5 4 1 1 1 1h8Zm-7.978-1A.261.261 0 0 1 7 12.996c.001-.264.167-1.03.76-1.72C8.312 10.629 9.282 10 11 10c1.717 0 2.687.63 3.24 1.276.593.69.758 1.457.76 1.72l-.008.002a.274.274 0 0 1-.014.002H7.022ZM11 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4Zm3-2a3 3 0 1 1-6 0 3 3 0 0 1 6 0ZM6.936 9.28a5.88 5.88 0 0 0-1.23-.247A7.35 7.35 0 0 0 5 9c-4 0-5 3-5 4 0 .667.333 1 1 1h4.216A2.238 2.238 0 0 1 5 13c0-1.01.377-2.042 1.09-2.904.243-.294.526-.569.846-.816ZM4.92 10A5.493 5.493 0 0 0 4 13H1c0-.26.164-1.03.76-1.724.545-.636 1.492-1.256 3.16-1.275ZM1.5 5.5a3 3 0 1 1 6 0 3 3 0 0 1-6 0Zm3-2a2 2 0 1 0 0 4 2 2 0 0 0 0-4Z"/>
                                                            </svg>
                                                        </a>
                                                        <a href="{% url 'tarea_financiera_dependencia_addone' tarea.id %}" class="btn btn-sm btn-warning" title="Agregar dependencia">
                                                            <i class="fas fa-link"></i>
                                                        </a> {% endcomment %}
                                                        <!-- En la sección de tareas financieras -->
                                                        <a href="#" class="btn btn-sm btn-secondary" title="Actualizar datos" style="background-color: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; transition: background-color 0.3s;" data-toggle="modal" data-target="#updateDataModal" data-url="{% url 'tarea_update_data' 'financiera' tarea.id %}">
                                                            <i class="fas fa-sync-alt"></i>
                                                        </a>
                                                        <a href="#" class="btn btn-sm btn-primary mr-1" title="Adjuntos" onclick="openAdjuntosModal({{ tarea.id }}, 'TAREA_FINANCIERA')">
                                                            <i class="fas fa-paperclip"></i>
                                                        </a>
                                                        {% if tarea.TF_BCOBRO_EMITIDO %}
                                                        <a href="#" class="btn btn-sm btn-danger" title="Eliminar" data-tarea-id="{{ tarea.id }}">
                                                            <i class="fas fa-trash"></i>
                                                        </a>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {{ tarea.TF_CCODIGO }}                                                        
                                                    </td>
                                                    <td>{{ tarea.TF_CDESCRIPCION }}</td>                                                
                                                    <td>{{ tarea.TF_FFECHA_INICIO|date:"d-m-Y" }}</td>                                                                
                                                    <td> {{ tarea.TF_MONEDA.MO_CMONEDA }} {{ tarea.TF_NMONTO|floatformat:2 }}</td>                                                
                                                    <td>{{ tarea.TF_MONEDA.MO_CMONEDA }} {{ tarea.TF_NMONTOPAGADO|floatformat:2 }}</td>                                                
                                                    <td style="width: 150px;">
                                                        <div class="progress" style="height: 20px; width: 100%;">
                                                            <div class="progress-bar {% if tarea.TF_NPROGRESO >= 100 %}bg-success{% elif tarea.TF_NPROGRESO >= 50 %}bg-info{% else %}bg-warning{% endif %}" 
                                                                role="progressbar" 
                                                                style="width: {% if tarea.TF_NPROGRESO > 100 %}100%{% else %}{{ tarea.TF_NPROGRESO }}%{% endif %};" 
                                                                aria-valuenow="{{ tarea.TF_NPROGRESO }}" 
                                                                aria-valuemin="0" 
                                                                aria-valuemax="100">
                                                                {{ tarea.TF_NPROGRESO }}%
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>{% if tarea.TF_BCOBRO_EMITIDO %}SI{% else %}NO{% endif %}</td>  
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td colspan="7">No hay tareas financieras registradas.</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>   
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="generales" role="tabpanel">
                                    <h5>Tareas Generales</h5>
                                    <div class="dt-responsive table-responsive">
                                        <table id="tabla-generales" class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Acción</th>
                                                    <th>Nombre</th>
                                                    <th>Descripción</th>
                                                    <th>Progreso</th>
                                                    <th>Estado</th>
                                                    <th>Fecha Inicio</th>
                                                    <th>Fecha Fin</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for tarea in tareas_general %}
                                                <tr>
                                                    <td>
                                                        <a href="{% url 'tarea_general_listone' tarea.id 1 %}" class="btn btn-sm btn-info mr-1" title="Ver detalles"><i class="fas fa-eye"></i></a>
                                                        <a href="{% url 'tarea_general_update' tarea.id 1 %}" class="btn btn-sm btn-primary mr-1" title="Editar"><i class="fas fa-edit"></i></a>
                                                        <a href="{% url 'tarea_general_update_asignaciones' tarea.id 1 %}" class="btn btn-sm btn-info mr-1" title="Asignar recursos">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-people" viewBox="0 0 16 16">
                                                                <path d="M15 14s1 0 1-1-1-4-5-4-5 3-5 4 1 1 1 1h8Zm-7.978-1A.261.261 0 0 1 7 12.996c.001-.264.167-1.03.76-1.72C8.312 10.629 9.282 10 11 10c1.717 0 2.687.63 3.24 1.276.593.69.758 1.457.76 1.72l-.008.002a.274.274 0 0 1-.014.002H7.022ZM11 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4Zm3-2a3 3 0 1 1-6 0 3 3 0 0 1 6 0ZM6.936 9.28a5.88 5.88 0 0 0-1.23-.247A7.35 7.35 0 0 0 5 9c-4 0-5 3-5 4 0 .667.333 1 1 1h4.216A2.238 2.238 0 0 1 5 13c0-1.01.377-2.042 1.09-2.904.243-.294.526-.569.846-.816ZM4.92 10A5.493 5.493 0 0 0 4 13H1c0-.26.164-1.03.76-1.724.545-.636 1.492-1.256 3.16-1.275ZM1.5 5.5a3 3 0 1 1 6 0 3 3 0 0 1-6 0Zm3-2a2 2 0 1 0 0 4 2 2 0 0 0 0-4Z"/>
                                                            </svg>
                                                        </a>
                                                        <a href="{% url 'tarea_general_dependencia_addone' tarea.id %}" class="btn btn-sm btn-warning" title="Agregar dependencia">
                                                            <i class="fas fa-link"></i>
                                                        </a>
                                                        <!-- En la sección de tareas generales -->
                                                        <a href="#" class="btn btn-sm btn-secondary" title="Actualizar datos" style="background-color: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; transition: background-color 0.3s;" data-toggle="modal" data-target="#updateDataModal" data-url="{% url 'tarea_update_data' 'general' tarea.id %}">
                                                            <i class="fas fa-sync-alt"></i>
                                                        </a>  
                                                        <a href="#" class="btn btn-sm btn-primary mr-1" title="Adjuntos" onclick="openAdjuntosModal({{ tarea.id }}, 'TAREA_GENERAL')">
                                                            <i class="fas fa-paperclip"></i>
                                                        </a>                                                
                                                    </td>
                                                    <td>
                                                        {{ tarea.TG_CNOMBRE }}
                                                        {% if tarea.tiene_asignacion_cero %}
                                                        <i class="fas fa-exclamation-triangle text-warning ml-2" title="Esta tarea tiene asignaciones con horas o costo en 0"></i>
                                                        {% endif %}
                                                    </td>
                                                    <td>{{ tarea.TG_CDESCRIPCION }}</td>
                                                    <td style="width: 150px;">
                                                        <div class="progress" style="height: 20px; width: 100%;">
                                                            <div class="progress-bar {% if tarea.TG_NPROGRESO >= 100 %}bg-success{% elif tarea.TG_NPROGRESO >= 50 %}bg-info{% else %}bg-warning{% endif %}" 
                                                                role="progressbar" 
                                                                style="width: {% if tarea.TG_NPROGRESO > 100 %}100%{% else %}{{ tarea.TG_NPROGRESO }}%{% endif %};" 
                                                                aria-valuenow="{{ tarea.TG_NPROGRESO }}" 
                                                                aria-valuemin="0" 
                                                                aria-valuemax="100">
                                                                {{ tarea.TG_NPROGRESO }}%
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>{{ tarea.TG_CESTADO }}</td>
                                                    <td>{{ tarea.TG_FFECHA_INICIO|date:"d/m/Y" }}</td>
                                                    <td>{{ tarea.TG_FFECHA_FIN_ESTIMADA|date:"d/m/Y" }}</td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td colspan="7">No hay tareas generales registradas.</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="ingenieria" role="tabpanel">
                                    <h5>Tareas de Ingeniería</h5>
                                    <div class="dt-responsive table-responsive">
                                        <table id="tabla-ingenieria" class="table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Acción</th>
                                                    <th>Nombre</th>
                                                    <th>Descripción</th>
                                                    <th>Progreso</th>
                                                    <th>Estado</th>
                                                    <th>Fecha Inicio</th>
                                                    <th>Fecha Fin</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for tarea in tareas_ingenieria %}
                                                <tr>
                                                    <td>
                                                        <a href="{% url 'tarea_ingenieria_listone' tarea.id 1 %}" class="btn btn-sm btn-info mr-1" title="Ver detalles"><i class="fas fa-eye"></i></a>
                                                        <a href="{% url 'tarea_ingenieria_update' tarea.id 1 %}" class="btn btn-sm btn-primary mr-1" title="Editar"><i class="fas fa-edit"></i></a>
                                                        <a href="{% url 'tarea_ingenieria_update_asignaciones' tarea.id 1 %}" class="btn btn-sm btn-info mr-1" title="Asignar recursos">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-people" viewBox="0 0 16 16">
                                                                <path d="M15 14s1 0 1-1-1-4-5-4-5 3-5 4 1 1 1 1h8Zm-7.978-1A.261.261 0 0 1 7 12.996c.001-.264.167-1.03.76-1.72C8.312 10.629 9.282 10 11 10c1.717 0 2.687.63 3.24 1.276.593.69.758 1.457.76 1.72l-.008.002a.274.274 0 0 1-.014.002H7.022ZM11 7a2 2 0 1 0 0-4 2 2 0 0 0 0 4Zm3-2a3 3 0 1 1-6 0 3 3 0 0 1 6 0ZM6.936 9.28a5.88 5.88 0 0 0-1.23-.247A7.35 7.35 0 0 0 5 9c-4 0-5 3-5 4 0 .667.333 1 1 1h4.216A2.238 2.238 0 0 1 5 13c0-1.01.377-2.042 1.09-2.904.243-.294.526-.569.846-.816ZM4.92 10A5.493 5.493 0 0 0 4 13H1c0-.26.164-1.03.76-1.724.545-.636 1.492-1.256 3.16-1.275ZM1.5 5.5a3 3 0 1 1 6 0 3 3 0 0 1-6 0Zm3-2a2 2 0 1 0 0 4 2 2 0 0 0 0-4Z"/>
                                                            </svg>
                                                        </a>
                                                        <a href="{% url 'tarea_ingenieria_dependencia_addone' tarea.id %}" class="btn btn-sm btn-warning" title="Agregar dependencia">
                                                            <i class="fas fa-link"></i>
                                                        </a>
                                                        <!-- En la sección de tareas de ingeniería -->
                                                        <a href="#" class="btn btn-sm btn-secondary" title="Actualizar datos" style="background-color: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; transition: background-color 0.3s;" data-toggle="modal" data-target="#updateDataModal" data-url="{% url 'tarea_update_data' 'ingenieria' tarea.id %}">
                                                            <i class="fas fa-sync-alt"></i>
                                                        </a>
                                                        <a href="#" class="btn btn-sm btn-primary mr-1" title="Adjuntos" onclick="openAdjuntosModal({{ tarea.id }}, 'TAREA_INGENIERIA')">
                                                            <i class="fas fa-paperclip"></i>
                                                        </a>
                                                    </td>
                                                    <td>
                                                        {{ tarea.TI_CNOMBRE }}
                                                        {% if tarea.tiene_asignacion_cero %}
                                                        <i class="fas fa-exclamation-triangle text-warning ml-2" title="Esta tarea tiene asignaciones con horas o costo en 0"></i>
                                                        {% endif %}
                                                    </td>
                                                    <td>{{ tarea.TI_CDESCRIPCION }}</td>
                                                    <td style="width: 150px;">
                                                        <div class="progress" style="height: 20px; width: 100%;">
                                                            <div class="progress-bar {% if tarea.TI_NPROGRESO >= 100 %}bg-success{% elif tarea.TI_NPROGRESO >= 50 %}bg-info{% else %}bg-warning{% endif %}" 
                                                                role="progressbar" 
                                                                style="width: {% if tarea.TI_NPROGRESO > 100 %}100%{% else %}{{ tarea.TI_NPROGRESO }}%{% endif %};" 
                                                                aria-valuenow="{{ tarea.TI_NPROGRESO }}" 
                                                                aria-valuemin="0" 
                                                                aria-valuemax="100">
                                                                {{ tarea.TI_NPROGRESO }}%
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td>{{ tarea.TI_CESTADO }}</td>
                                                    <td>{{ tarea.TI_FFECHA_INICIO|date:"d/m/Y" }}</td>
                                                    <td>{{ tarea.TI_FFECHA_FIN_ESTIMADA|date:"d/m/Y" }}</td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td colspan="7">No hay tareas de ingeniería registradas.</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Carta Gantt -->
                <div class="col-md-12 mt-4">
                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5>Carta Gantt del Proyecto</h5>
                        </div>
                        <div class="card-body">
                            <div id="gantt"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- [ Main Content ] end -->             
        </div>
    </section>
    <!-- [ Main Content ] end -->
    <!-- Modal -->
    <div class="modal fade" id="updateDataModal" tabindex="-1" role="dialog" aria-labelledby="updateDataModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">                
                <div class="modal-body">
                    <!-- El contenido del modal se cargará aquí -->
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="clienteModal" tabindex="-1" role="dialog" aria-labelledby="clienteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">                
                <div class="modal-body">
                    <!-- El contenido del modal se cargará aquí -->
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="documentosModal" tabindex="-1" role="dialog" aria-labelledby="documentosModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">                
                <div class="modal-body">
                    <!-- El contenido del modal se cargará aquí -->
                </div>
            </div>
        </div>
    </div>

    <!-- Include del modal de adjuntos -->
    {% include "home/TAREA/tarea_documents.html" %}

    <!-- Modal EDP -->
    <div class="modal fade" id="edpModal" tabindex="-1" role="dialog" aria-labelledby="edpModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title text-white" id="edpModalLabel">Agregar Elemento</h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="edpForm">
                        <div class="form-row">
                            <div class="form-group col-md-4">
                                <label for="cantidadEdp">Cantidad</label>
                                <input type="number" class="form-control" id="cantidadEdp" min="1" max="50" required>
                                <small class="form-text text-muted">Máximo 50</small>
                            </div>
                            <div class="form-group col-md-4">
                                <label for="diaEmision">Día de emisión</label>
                                <input type="number" class="form-control" id="diaEmision" min="1" max="31" required>
                            </div>
                            <div class="form-group col-md-4">
                                <label for="fechaInicio">Fecha de inicio</label>
                                <input type="date" class="form-control" id="fechaInicio" required>
                            </div>
                        </div>
                        <div class="table-responsive mt-4">
                            <table class="table table-bordered table-striped" id="edpTable">
                                <thead class="thead-light">
                                    <tr>
                                        <th width="20%">Fecha</th>
                                        <th width="25%">Monto</th>
                                        <th width="20%">Moneda</th>
                                        <th width="35%">Descripción</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Las filas se generarán dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                        {% comment %} <div class="form-group mt-4">
                            <label for="comentarioGeneral">Comentario General</label>
                            <textarea class="form-control" id="comentarioGeneral" rows="3"></textarea>
                        </div> {% endcomment %}
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="guardarEdp">Guardar</button>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
    <!-- datatable Js -->
    <script src="/static/assets/js/plugins/jquery.dataTables.min.js"></script>
    <script src="/static/assets/js/plugins/dataTables.bootstrap4.min.js"></script>
    <script src="/static/assets/js/plugins/buttons.colVis.min.js"></script>
    <script src="/static/assets/js/plugins/buttons.print.min.js"></script>
    <script src="/static/assets/js/plugins/pdfmake.min.js"></script>
    <script src="/static/assets/js/plugins/jszip.min.js"></script>
    <script src="/static/assets/js/plugins/dataTables.buttons.min.js"></script>
    <script src="/static/assets/js/plugins/buttons.html5.min.js"></script>
    <script src="/static/assets/js/plugins/buttons.bootstrap4.min.js"></script>
    <script src="/static/assets/js/pages/data-export-custom.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Frappe Gantt JS -->
    <script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    {% comment %} <script type="text/javascript" src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script> {% endcomment %}
    {% comment %} <script type="text/javascript" src="https://cdn.datatables.net/1.10.24/js/dataTables.bootstrap4.min.js"></script> {% endcomment %}
    <script>
        $(document).ready(function() {
            $('#tabla_detalle_apertura').DataTable({
                "paging": true,
                "ordering": true,
                "info": true,
                "searching": true,
                "lengthChange": true,
                "pageLength": 30,
                "responsive": true,
                "autoWidth": false,
               
            });
        });

        // Función para ajustar el ancho de las columnas
        function adjustColumnWidths() {
            $('.table-responsive table').each(function() {
                var $table = $(this);
                var totalWidth = $table.width();
                var $columns = $table.find('th');
                var totalColumns = $columns.length;
                var availableWidth = totalWidth - 350; // 200px para acciones + 150px para progreso
                var columnWidth = availableWidth / (totalColumns - 2);
                
                $columns.each(function(index) {
                    if (index !== 0 && index !== 3) { // No ajustar columnas de acciones y progreso
                        $(this).css('width', columnWidth + 'px');
                    }
                });
            });
        }

        // Variables globales para adjuntos
        var currentTareaId, currentTipoTarea;

        // Función para abrir el modal de adjuntos
        function openAdjuntosModal(tareaId, tipoTarea) {
            currentTareaId = tareaId;
            currentTipoTarea = tipoTarea;
            $('#adjuntosModal').modal('show');
            cargarListaAdjuntos();
        }

        // Función para cargar la lista de adjuntos
        function cargarListaAdjuntos() {
            $.ajax({
                url: `/tarea_adjuntos/${currentTareaId}/${currentTipoTarea}/`,
                method: 'GET',
                success: function(data) {
                    var tableHtml = '<table class="table table-striped">' +
                                    '<thead><tr><th>Nombre</th><th>Descripción</th><th>Fecha de Creación</th><th>Acciones</th></tr></thead>' +
                                    '<tbody>';
                    
                    if (data.adjuntos.length === 0) {
                        tableHtml += '<tr><td colspan="4" class="text-center">No hay adjuntos para esta tarea.</td></tr>';
                    } else {
                        data.adjuntos.forEach(function(adjunto) {
                            tableHtml += `<tr>
                                <td>${adjunto.nombre}</td>
                                <td>${adjunto.descripcion}</td>
                                <td>${adjunto.fecha_creacion}</td>
                                <td>
                                    <button onclick="editarAdjunto(${adjunto.id})" class="btn btn-primary btn-sm"><i class="fas fa-edit"></i> Editar</button>
                                    <button onclick="eliminarAdjunto(${adjunto.id})" class="btn btn-danger btn-sm"><i class="fas fa-trash-alt"></i> Eliminar</button>
                                    <a href="/tarea_adjunto/descargar/${adjunto.id}/${currentTipoTarea}/" class="btn btn-success btn-sm"><i class="fas fa-download"></i> Descargar</a>
                                </td>
                            </tr>`;
                        });
                    }
                    
                    tableHtml += '</tbody></table>';
                    $('#lista').html(tableHtml);
                },
                error: function(xhr, status, error) {
                    console.error("Error al cargar los adjuntos:", error);
                    $('#lista').html('<p class="text-danger">Error al cargar los adjuntos. Por favor, intente nuevamente.</p>');
                }
            });
        }

        // Función para editar adjunto
        function editarAdjunto(adjuntoId) {
            $.ajax({
                url: `/tarea_adjunto/editar/${adjuntoId}/${currentTipoTarea}/`,
                method: 'GET',
                success: function(data) {
                    $('#editar').html(data);
                    $('#editar-tab').show().tab('show');
                    
                    $('#adjuntoForm').off('submit').on('submit', function(e) {
                        e.preventDefault();
                        var formData = new FormData(this);
                        
                        $.ajax({
                            url: `/tarea_adjunto/editar/${adjuntoId}/${currentTipoTarea}/`,
                            type: 'POST',
                            data: formData,
                            headers: {
                                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                            },
                            success: function(response) {
                                if (response.success) {
                                    alert(response.message);
                                    cargarListaAdjuntos();
                                    $('#lista-tab').tab('show');
                                    $('#editar-tab').hide();
                                } else {
                                    alert('Error: ' + response.message);
                                }
                            },
                            error: function(xhr, errmsg, err) {
                                console.log(xhr.status + ": " + xhr.responseText);
                                alert('Error al editar el adjunto');
                            },
                            cache: false,
                            contentType: false,
                            processData: false
                        });
                    });
                },
                error: function(xhr, status, error) {
                    console.error("Error al cargar el formulario de edición:", error);
                    alert('Error al cargar el formulario de edición');
                }
            });
        }

        // Función para eliminar adjunto
        function eliminarAdjunto(adjuntoId) {
            if (confirm('¿Está seguro de que desea eliminar este adjunto?')) {
                $.ajax({
                    url: `/tarea_adjunto/eliminar/${adjuntoId}/${currentTipoTarea}/`,
                    method: 'POST',
                    data: {
                        csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            alert(response.message);
                            cargarListaAdjuntos();
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error("Error al eliminar el adjunto:", error);
                        alert('Error al eliminar el adjunto');
                    }
                });
            }
        }


        function confirmarEliminarEDP(tareaId) {
            Swal.fire({
                title: '¿Estás seguro?',
                text: "Esta acción eliminará la Tarea y el Estado de Pago, no se puede deshacer.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    eliminarEDP(tareaId);
                }
            });
        }
        
        function eliminarEDP(tareaId) {
            $.ajax({
                url: `/tarea_financiera_delete_edp/${tareaId}/`,
                type: 'POST',
                data: {
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val()
                },
                success: function(response) {
                    if (response.success) {
                        Swal.fire({
                            title: '¡Eliminado!',
                            text: 'El Estado de Pago ha sido eliminado.',
                            icon: 'success',
                            confirmButtonText: 'OK'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                // Forzar recarga completa desde el servidor
                                window.location.href = window.location.href;
                            }
                        });
                    } else {
                        Swal.fire(
                            'Error',
                            response.message,
                            'error'
                        );
                    }
                },
                error: function() {
                    Swal.fire(
                        'Error',
                        'Hubo un problema al eliminar el Estado de Pago.',
                        'error'
                    );
                }
            });
        }

        // Código principal que se ejecuta cuando el documento está listo
        $(document).ready(function() {
            // Llamar a la función de ajuste de columnas al cargar y al cambiar el tamaño de la ventana
            {% comment %} adjustColumnWidths();
            $(window).resize(adjustColumnWidths); {% endcomment %}

            {% comment %} $('#tabla-financieras').DataTable({
            });
            
            $('#tabla-generales').DataTable({            
            });
            
            $('#tabla-ingenieria').DataTable({               
            }); {% endcomment %}

            // Manejo del modal de actualización de datos
            $('#updateDataModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);
                var url = button.data('url');
                var modal = $(this);
                
                // Limpiar el contenido del modal antes de cargar nuevos datos
                modal.find('.modal-body').empty();
                
                // Mostrar un indicador de carga
                modal.find('.modal-body').html('<div class="text-center"><i class="fas fa-spinner fa-spin fa-3x"></i></div>');
                
                // Cargar el contenido del modal
                $.ajax({
                    url: url,
                    method: 'GET',
                    success: function(data) {
                        modal.find('.modal-body').html(data);
                        
                        $('#formEditarTarea').append('<div id="mensajeErrorHoras" class="alert alert-danger mt-3" style="display: none;"></div>');
            
                        $('#formEditarTarea').off('submit').on('submit', function(e) {
                            e.preventDefault();
                            if (horasValidas) {
                                $.ajax({
                                    url: url,
                                    method: 'POST',
                                    data: $(this).serialize(),
                                    dataType: 'json',
                                    success: function(response) {
                                        if (response.success) {
                                            $('#updateDataModal').modal('hide');
                                            Swal.fire({
                                                icon: 'success',
                                                title: 'Éxito',
                                                text: response.message,
                                                showConfirmButton: false,
                                                timer: 1500
                                            }).then(() => {
                                                if (response.redirect_url) {
                                                    window.location.href = response.redirect_url;
                                                } else {
                                                    location.reload();
                                                }
                                            });
                                        } else {
                                            $('#updateDataModal').modal('hide');
                                            Swal.fire({
                                                icon: 'error',
                                                title: 'Error',
                                                text: response.message
                                            });
                                        }
                                    },
                                    error: function(xhr, status, error) {
                                        $('#updateDataModal').modal('hide');
                                        Swal.fire({
                                            icon: 'error',
                                            title: 'Error',
                                            text: 'Hubo un problema al procesar la solicitud. Por favor, inténtelo de nuevo.'
                                        });
                                    }
                                });
                            }
                        });
            
                        $('input[name^="horas_"], #horasTarea').on('input', validarHoras);
                        validarHoras();
            
                        // Inicializar cualquier otro comportamiento específico del modal aquí
                        inicializarModal();
                    },
                    error: function() {
                        $('#updateDataModal').modal('hide');
                        modal.find('.modal-body').html('<div class="alert alert-danger">Error al cargar los datos. Por favor, intente de nuevo.</div>');
                    }
                });
            });
        
            // Limpiar el contenido del modal cuando se cierre
            $('#updateDataModal').on('hidden.bs.modal', function () {
                $(this).find('.modal-body').empty();
            });
            
            // Manejo del modal de información del cliente
            $('button[data-target="#clienteModal"]').on('click', function(event) {
                event.preventDefault();
                var url = $(this).data('url');
                $('#clienteModal').find('.modal-body').empty();
                $('#clienteModal').find('.modal-body').load(url, function() {
                    $('#clienteModal').modal('show');
                });
            });

            $('#clienteModal').on('hidden.bs.modal', function () {
                $(this).find('.modal-body').empty();
            });

            // Manejo del modal de documentos
            $('button[data-toggle="modal"][data-target="#documentosModal"]').on('click', function(event) {
                event.preventDefault();
                var url = $(this).data('url');
                $.ajax({
                    url: url,
                    method: 'GET',
                    success: function(response) {
                        $('#documentosModal').find('.modal-content').html(response);
                        $('#documentosModal').modal('show');
                    },
                    error: function(xhr, status, error) {
                        console.error('Error loading modal content:', error);
                        alert('Error loading modal content. Please try again.');
                    }
                });
            });

            $('#documentosModal').on('hidden.bs.modal', function () {
                $(this).find('.modal-content').empty();
            });

            // Manejo de adjuntos
            $('#formAgregarAdjunto').on('submit', function(e) {
                e.preventDefault();
                var formData = new FormData(this);
                
                $.ajax({
                    url: `/tarea_adjunto/agregar/${currentTareaId}/${currentTipoTarea}/`,
                    type: 'POST',
                    data: formData,
                    success: function(response) {
                        if (response.success) {
                            alert(response.message);
                            $('#formAgregarAdjunto')[0].reset();
                            cargarListaAdjuntos();
                            $('#lista-tab').tab('show');
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function(xhr, errmsg, err) {
                        console.log(xhr.status + ": " + xhr.responseText);
                        alert('Error al agregar el adjunto');
                    },
                    cache: false,
                    contentType: false,
                    processData: false
                });
            });

            // Manejo del modal EDP
            let monedaOptions = [];
            let clpPresente = false;

            // Generar opciones de moneda
            {% for md in moneda %}
                monedaOptions.push('<option value="{{ md.id }}">{{ md.MO_CMONEDA }}</option>');
                if ('{{ md.MO_CMONEDA }}'.toUpperCase() === 'CLP') {
                    clpPresente = true;
                }
            {% endfor %}

            if (!clpPresente) {
                monedaOptions.unshift('<option value="CLP" selected>CLP</option>');
            }

            function generarFilasTabla() {
                let cantidad = parseInt($('#cantidadEdp').val());
                let diaEmision = parseInt($('#diaEmision').val());
                let fechaInicio = $('#fechaInicio').val();
                
                if (!cantidad || isNaN(cantidad) || !diaEmision || isNaN(diaEmision) || !fechaInicio) {
                    $('#edpTable tbody').empty();
                    return;
                }

                fechaInicio = new Date(fechaInicio + 'T00:00:00');
                let tbody = $('#edpTable tbody');
                tbody.empty();
            
                for (let i = 0; i < cantidad; i++) {
                    let fecha = new Date(fechaInicio);
                    fecha.setMonth(fecha.getMonth() + i);
                    
                    let ultimoDiaMes = new Date(fecha.getFullYear(), fecha.getMonth() + 1, 0).getDate();
                    let diaAjustado = Math.min(diaEmision, ultimoDiaMes);
                    fecha.setDate(diaAjustado);
            
                    let fechaFormateada = fecha.getFullYear() + '-' + 
                                        String(fecha.getMonth() + 1).padStart(2, '0') + '-' + 
                                        String(fecha.getDate()).padStart(2, '0');
                    
                    let fila = `<tr>
                        <td><input type="date" class="form-control form-control-sm fecha-edp" value="${fechaFormateada}" required></td>
                        <td><input type="number" class="form-control form-control-sm monto" required></td>
                        <td><select class="form-control form-control-sm moneda">${monedaOptions.join('')}</select></td>
                        <td><input type="text" class="form-control form-control-sm medio-pago" required></td>
                    </tr>`;
                    tbody.append(fila);
                }

                $('.moneda').val('CLP');
            }

            // Modificar los eventos para los campos
            $('#cantidadEdp, #diaEmision, #fechaInicio').on('change input', function() {
                generarFilasTabla();
            });

            {% comment %} $('#fechaInicio').on('change', generarFilasTabla); {% endcomment %}

            $('#guardarEdp').click(function() {
                let datos = {
                    cantidad: $('#cantidadEdp').val(),
                    diaEmision: $('#diaEmision').val(),
                    fechaInicio: $('#fechaInicio').val(),
                    montos: [],
                    mediosPago: [],
                    fechasEmision: [],
                    monedas: [],
                    comentarioGeneral: $('#comentarioGeneral').val(),
                    idProyecto: {{ proyecto.id }},
                };

                let datosValidos = true;

                $('#edpTable tbody tr').each(function() {
                    let fecha = $(this).find('.fecha-edp').val();
                    let monto = $(this).find('.monto').val();
                    let medioPago = $(this).find('.medio-pago').val();
                    let moneda = $(this).find('.moneda').val();
            
                    if (!fecha || !monto || !medioPago) {
                        datosValidos = false;
                        return false;
                    }
            
                    datos.fechasEmision.push(fecha);
                    datos.montos.push(monto);
                    datos.mediosPago.push(medioPago);
                    datos.monedas.push(moneda);
                });

                if (!datosValidos) {
                    alert('Por favor, complete todos los campos antes de guardar.');
                    return;
                }

                console.log('Datos a enviar:', datos);  // Imprimir datos antes de enviar

                $.ajax({
                    type: 'POST',
                    url: '/tarea_financiera_add_edp/',
                    data: JSON.stringify(datos),
                    contentType: 'application/json',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                        console.log('Respuesta del servidor:', response);
                        $('#edpModal').modal('hide');
                        Swal.fire({
                            icon: 'success',
                            title: '¡Éxito!',
                            text: 'Los datos se han guardado correctamente.',
                            confirmButtonText: 'OK'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                location.reload();
                            }
                        });
                    },
                    error: function(xhr, status, error) {
                        console.error('Error al guardar los datos:', error);
                        alert('Hubo un error al guardar los datos. Por favor, inténtelo de nuevo.');
                    }
                });
            });

            $('#diaEmision').on('input', function() {
                let valor = $(this).val();
                if (valor < 1) $(this).val(1);
                if (valor > 31) $(this).val(31);
            });

            $('#edpModal').on('shown.bs.modal', function() {
                $('#edpTable tbody').empty();
                $('#cantidadEdp').val('');
                $('#diaEmision').val('');
                $('#fechaInicio').val('');
                $('#comentarioGeneral').val('');
            });

            $('#cantidadEdp').on('input', function() {
                let valor = parseInt($(this).val());
                if (valor > 50) {
                    $(this).val(50);
                } else if (valor < 1) {
                    $(this).val(1);
                }
                if ($('#diaEmision').val() && $('#fechaInicio').val()) {
                    generarFilasTabla();
                }
            });
            
            $('#diaEmision').on('input', function() {
                let valor = $(this).val();
                if (valor < 1) $(this).val(1);
                if (valor > 31) $(this).val(31);
                if ($('#cantidadEdp').val() && $('#fechaInicio').val()) {
                    generarFilasTabla();
                }
            });

            // Asociar el evento de clic al botón de eliminar
            $('a.btn-danger[title="Eliminar"]').on('click', function(e) {
                e.preventDefault();
                var tareaId = $(this).data('tarea-id');
                confirmarEliminarEDP(tareaId);
            });
        });

        // Código para el gráfico Gantt
        document.addEventListener('DOMContentLoaded', function() {
            var tasks = [];
            
            function getDependencies(tareaId) {
                var dependencies = [];
                {% for dep in dependencias_general %}
                    if ('TG{{ dep.TD_TAREA_SUCESORA.id }}' === tareaId) {
                        dependencies.push('TG{{ dep.TD_TAREA_PREDECESORA.id }}');
                    }
                {% endfor %}
                {% for dep in dependencias_ingenieria %}
                    if ('TI{{ dep.TD_TAREA_SUCESORA.id }}' === tareaId) {
                        dependencies.push('TI{{ dep.TD_TAREA_PREDECESORA.id }}');
                    }
                {% endfor %}
                {% for dep in dependencias_financiera %}
                    if ('TF{{ dep.TD_TAREA_SUCESORA.id }}' === tareaId) {
                        dependencies.push('TF{{ dep.TD_TAREA_PREDECESORA.id }}');
                    }
                {% endfor %}
                return dependencies.join(',');
            }

            function createTask(id, name, start, end, progress, isMilestone, isCritical) {
                var dependencies = getDependencies(id);
                return {
                    id: id,
                    name: name,
                    start: start,
                    end: end,
                    dependencies: dependencies,
                    progress: Math.min(100, Math.max(0, parseFloat(progress) || 0)),
                    custom_class: isMilestone ? 'milestone' : 'task-with-progress',
                    is_critical: isCritical
                };
            }

            // Agregar tareas generales            
            {% for tarea in tareas_general %}
                try {
                    tasks.push(createTask(
                        'TG{{ tarea.id }}',
                        '{{ tarea.TG_CNOMBRE|escapejs }} ({{ tarea.TG_NPROGRESO }}%)',
                        '{{ tarea.TG_FFECHA_INICIO|date:"Y-m-d" }}',
                        '{{ tarea.TG_FFECHA_FIN_ESTIMADA|date:"Y-m-d" }}',
                        '{{ tarea.TG_NPROGRESO }}',
                        {{ tarea.TG_BMILESTONE|yesno:"true,false" }},
                        {{ tarea.TG_BCRITICA|yesno:"true,false" }}
                    ));
                } catch (error) {
                    console.error('Error al crear tarea general:', error);
                }
            {% endfor %}
            
            // Agregar tareas de ingeniería
            {% for tarea in tareas_ingenieria %}
                try {
                    tasks.push(createTask(
                        'TI{{ tarea.id }}',
                        '{{ tarea.TI_CNOMBRE|escapejs }} ({{ tarea.TI_NPROGRESO }}%)',
                        '{{ tarea.TI_FFECHA_INICIO|date:"Y-m-d" }}',
                        '{{ tarea.TI_FFECHA_FIN_ESTIMADA|date:"Y-m-d" }}',
                        '{{ tarea.TI_NPROGRESO }}',
                        {{ tarea.TI_BMILESTONE|yesno:"true,false" }},
                        {{ tarea.TG_BCRITICA|yesno:"true,false" }}
                    ));
                } catch (error) {
                    console.error('Error al crear tarea de ingeniería:', error);
                }
            {% endfor %}
            
            // Agregar tareas financieras
            {% for tarea in tareas_financiera %}
                try {
                    tasks.push(createTask(
                        'TF{{ tarea.id }}',
                        '{{ tarea.TF_CNOMBRE|escapejs }} ({{ tarea.TF_NPROGRESO }}%)',
                        '{{ tarea.TF_FFECHA_INICIO|date:"Y-m-d" }}',
                        '{{ tarea.TF_FFECHA_FIN_ESTIMADA|date:"Y-m-d" }}',
                        '{{ tarea.TF_NPROGRESO }}',
                        {{ tarea.TF_BMILESTONE|yesno:"true,false" }},
                        {{ tarea.TG_BCRITICA|yesno:"true,false" }}
                    ));
                } catch (error) {
                    console.error('Error al crear tarea financiera:', error);
                }
            {% endfor %}

            // Ordenar las tareas por fecha de inicio
            tasks.sort(function(a, b) {
                return new Date(a.start) - new Date(b.start);
            });
            console.log('Tareas:', tasks);

            var ganttElement = document.getElementById('gantt');
            if (ganttElement && tasks.length > 0) {
                // Encontrar la fecha más temprana y la más tardía
                var minDate = new Date(Math.min.apply(null, tasks.map(function(task) {
                    return new Date(task.start);
                })));
                var maxDate = new Date(Math.max.apply(null, tasks.map(function(task) {
                    return new Date(task.end);
                })));

                var gantt = new Gantt("#gantt", tasks, {
                    view_modes: ['Quarter Day', 'Half Day', 'Day', 'Week', 'Month'],
                    view_mode: 'Week',
                    date_format: 'YYYY-MM-DD',
                    language: 'es',
                    start_date: minDate,
                    end_date: maxDate,
                    bar_height: 40,
                    bar_corner_radius: 3,
                    arrow_curve: 5,
                    padding: 18,
                    on_click: function (task) {
                        console.log('Tarea clickeada:', task);
                    },
                    on_view_change: function(mode) {
                        console.log('Modo de vista cambiado:', mode);
                    },
                    readonly: true,
                    drag_progress: false,
                    allow_resize: false,
                    allow_drag: false,
                    custom_popup_html: function(task) {
                        // Personalizar el popup para mostrar información adicional
                        return `
                            <div class="details-container" style="width: 350px; background-color: rgba(0, 0, 0, 0.8); border-radius: 10px; padding: 15px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                                <h3 style="font-weight: bold; color: #ffffff; margin-bottom: 15px; font-size: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.2); padding-bottom: 10px;">${task.name}</h3>
                                <p style="color: #f0f0f0; margin: 8px 0; font-size: 15px;"><i class="fas fa-calendar-alt" style="margin-right: 8px; color: #3498db;"></i><strong>Inicio:</strong> ${task.start}</p>
                                <p style="color: #f0f0f0; margin: 8px 0; font-size: 15px;"><i class="fas fa-calendar-check" style="margin-right: 8px; color: #2ecc71;"></i><strong>Fin:</strong> ${task.end}</p>
                                <p style="color: #f0f0f0; margin: 8px 0; font-size: 15px;"><i class="fas fa-tasks" style="margin-right: 8px; color: #f39c12;"></i><strong>Progreso:</strong> <span style="background-color: rgba(255,255,255,0.2); padding: 3px 8px; border-radius: 12px; font-weight: bold;">${task.progress}%</span></p>
                                <p style="color: #f0f0f0; margin: 8px 0; font-size: 15px;"><i class="fas fa-flag" style="margin-right: 8px; color: #e74c3c;"></i><strong>Tipo:</strong> <span style="text-transform: uppercase; font-weight: bold; color: ${task.custom_class === 'milestone' ? '#e74c3c' : '#3498db'};">${task.custom_class === 'milestone' ? 'Hito' : 'Tarea'}</span></p>
                                <p style="color: #f0f0f0; margin: 8px 0; font-size: 15px;"><i class="fas fa-exclamation-triangle" style="margin-right: 8px; color: ${task.is_critical ? '#e74c3c' : '#3498db'};"></i><strong>Crítica:</strong> <span style="font-weight: bold; color: ${task.is_critical ? '#e74c3c' : '#3498db'};">${task.is_critical ? 'Sí' : 'No'}</span></p>
                            </div>
                        `;
                    }
                });

                // Crear botones para cambiar entre vistas
                var viewModes = [
                    {mode: 'Quarter Day', text: 'Cuarto de día'},
                    {mode: 'Half Day', text: 'Medio día'},
                    {mode: 'Day', text: 'Día'},
                    {mode: 'Week', text: 'Semana'},
                    {mode: 'Month', text: 'Mes'}
                ];
                var buttonContainer = document.createElement('div');
                buttonContainer.style.marginBottom = '20px';
                buttonContainer.style.textAlign = 'center';
                
                viewModes.forEach(function(viewMode) {
                    var button = document.createElement('button');
                    button.innerText = viewMode.text;
                    button.style.margin = '0 5px';
                    button.style.padding = '8px 12px';
                    button.style.backgroundColor = '#007bff';
                    button.style.color = 'white';
                    button.style.border = 'none';
                    button.style.borderRadius = '4px';
                    button.style.cursor = 'pointer';
                    button.style.transition = 'background-color 0.3s';
                    button.onmouseover = function() {
                        this.style.backgroundColor = '#0056b3';
                    };
                    button.onmouseout = function() {
                        this.style.backgroundColor = '#007bff';
                    };
                    button.onclick = function() {
                        gantt.change_view_mode(viewMode.mode);
                        // Resaltar el botón activo
                        buttonContainer.querySelectorAll('button').forEach(btn => btn.style.backgroundColor = '#007bff');
                        this.style.backgroundColor = '#0056b3';
                    };
                    buttonContainer.appendChild(button);
                });

                ganttElement.parentNode.insertBefore(buttonContainer, ganttElement);

                // Ajustar la vista inicial
                gantt.change_view_mode('Week');
            } else if (ganttElement) {
                ganttElement.innerHTML = 'No hay tareas para mostrar';
            }

            // Agregar estilos para mostrar el progreso en las tareas
            var style = document.createElement('style');
            style.textContent = `
                .task-with-progress .bar-progress {
                    position: relative;
                }
                .task-with-progress .bar-progress::after {
                    content: attr(data-progress) '%';
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    color: white;
                    font-weight: bold;
                    text-shadow: 1px 1px 2px black;
                }
            `;
            document.head.appendChild(style);

            $('.bar-wrapper').on('mousedown', (e, element) => {
                e.preventDefault();
                e.stopPropagation();
            });
            $('.handle').on('mousedown', (e, element) => {
                e.preventDefault();
                e.stopPropagation();
            });
            // Prevenir arrastre en elementos de Gantt
            document.querySelectorAll('.bar-wrapper, .handle').forEach(function(element) {
                element.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                });
            });
        });
    </script>
{% endblock javascripts %}